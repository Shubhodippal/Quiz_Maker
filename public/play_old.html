<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Join Quiz</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
      --border:#1f2937; --accent:#16a34a; --accent-ink:#062b12; --primary:#2563eb;
      --danger:#ef4444; --warn:#f59e0b;
    }
    /* layout */
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    .wrap{max-width:960px;margin:24px auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1,h2,h3{margin:0 0 12px 0}
    .muted{color:var(--muted)}
    /* inputs/buttons */
    input{padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1426;color:var(--ink)}
    input:focus{outline:2px solid #3352d1;border-color:#3352d1}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{padding:12px 16px;border-radius:12px;border:0;cursor:pointer;color:#fff;background:var(--accent)}
    .btn.primary{background:var(--primary)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    /* option cards */
    .opts{display:grid;gap:12px;margin-top:10px}
    .opt{
      position:relative;background:#0c152b;border:1px solid var(--border);
      border-radius:14px;padding:14px 16px;cursor:pointer;transition:transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .opt:hover{transform:translateY(-1px);border-color:#284e9e}
    .opt.disabled{opacity:.55;pointer-events:none}
    .opt .bullet{
      width:18px;height:18px;border-radius:50%;border:2px solid #2a3a64;display:inline-flex;align-items:center;justify-content:center;margin-right:10px;flex:0 0 18px;
    }
    .opt .text{flex:1}
    .opt.picked{border-color:var(--accent);background:#0d1f16}
    .opt.picked .bullet{border-color:var(--accent);background:var(--accent)}
    .opt.correct{outline:2px solid var(--accent)}
    .opt.incorrect{outline:2px solid var(--danger)}
    .opt-row{display:flex;align-items:center;gap:10px}
    /* header/status */
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1526;border:1px solid var(--border);color:var(--muted);font-size:13px}
    .progress{position:relative;height:8px;background:#0b1526;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:10px}
    .bar{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#3b82f6,#22c55e)}
    /* toast */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#e5e7eb;border:1px solid var(--border);border-radius:12px;padding:10px 14px;opacity:0;pointer-events:none;transition:opacity .2s ease}
    .toast.show{opacity:1}
    /* responsive option grid */
    @media (min-width:680px){ .opts{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="register">
      <h1>Join the Quiz</h1>
      <p class="muted">Room code: <span id="room"></span></p>
      <div class="row" style="margin:10px 0 12px">
        <input id="name" placeholder="Your name" style="flex:1 1 220px">
        <input id="email" placeholder="Email (optional)" style="flex:1 1 220px">
        <input id="phone" placeholder="Phone (optional)" style="flex:1 1 180px">
      </div>
      <button class="btn primary" id="join">Join Room</button>
    </div>

    <div class="card" id="game" style="display:none;">
      <div class="header">
        <div class="muted">Player: <strong id="playerName"></strong> Â· <span class="badge"><span id="playerId"></span></span></div>
        <div class="badge" id="status">Waitingâ€¦</div>
      </div>

      <h2 id="qtext">Waiting for next questionâ€¦</h2>
      <div class="progress"><div class="bar" id="pbar"></div></div>

      <div class="opts" id="opts"></div>

      <div class="muted" id="note" style="margin-top:10px;">Pick one option before timeâ€™s up. Youâ€™ll see what you chose highlighted.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const params = new URLSearchParams(location.search);
  const code = params.get('room');
  document.getElementById('room').textContent = code || 'â€”';

  // state
  let player = null;
  let ws = null;
  let chosenId = null;          // selected option id (prefixed)
  let deadline = 0;
  let timer = null;

  // elements
  const $reg = document.getElementById('register');
  const $game = document.getElementById('game');
  const $playerName = document.getElementById('playerName');
  const $playerId = document.getElementById('playerId');
  const $status = document.getElementById('status');
  const $qtext = document.getElementById('qtext');
  const $opts = document.getElementById('opts');
  const $pbar = document.getElementById('pbar');
  const $note = document.getElementById('note');
  const $toast = document.getElementById('toast');

  function toast(msg, ms=1400){
    $toast.textContent = msg;
    $toast.classList.add('show');
    setTimeout(()=> $toast.classList.remove('show'), ms);
  }

  function setDisabled(dis){
    document.querySelectorAll('.opt').forEach(el=>{
      if(dis) el.classList.add('disabled'); else el.classList.remove('disabled');
    });
  }

  function percentageLeft(){
    const total = Math.max(0, deadline - (deadline - 25_000)); // 25s window
    const remain = Math.max(0, deadline - Date.now());
    return total ? Math.max(0, Math.min(100, Math.round((remain/25_000)*100))) : 0;
  }

  function startCountdown(dl){
    stopCountdown();
    deadline = dl;
    tick(); // initial
    timer = setInterval(tick, 150);
    function tick(){
      const now = Date.now();
      const remain = Math.max(0, dl - now);
      const secs = Math.ceil(remain/1000);
      $status.textContent = remain>0 ? `Time left: ${secs}s` : 'Time up';
      $pbar.style.width = `${percentageLeft()}%`;
      if(remain <= 0){
        setDisabled(true);
        stopCountdown();
      }
    }
  }

  function stopCountdown(){
    if(timer){ clearInterval(timer); timer = null; }
  }

  function clearOptions(){
    $opts.innerHTML = '';
    chosenId = null;
    setDisabled(false);
  }

  function renderQuestion(q, dl){
    clearOptions();
    if(!q){
      $qtext.textContent = 'Quiz over! ðŸŽ‰';
      $status.textContent = 'Finished';
      $note.textContent = 'Thanks for playing.';
      $pbar.style.width = '0%';
      return;
    }
    $qtext.textContent = q.text;
    $note.textContent = 'Tap once to choose. You canâ€™t change after submitting.';
    (q.options || []).forEach((o, idx)=>{
      const el = document.createElement('div');
      el.className = 'opt';
      el.dataset.oid = o.id;

      const row = document.createElement('div');
      row.className = 'opt-row';

      const bullet = document.createElement('div');
      bullet.className = 'bullet';
      bullet.innerHTML = ''; // filled when picked

      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = o.text;

      row.appendChild(bullet);
      row.appendChild(text);
      el.appendChild(row);

      el.onclick = () => {
        if(!player || chosenId) return;
        chosenId = o.id;
        markPicked(chosenId);
        sendAnswer(chosenId);
        toast('Answer submitted');
        setDisabled(true);
      };
      $opts.appendChild(el);
    });
    if(dl) startCountdown(dl);
  }

  function markPicked(id){
    document.querySelectorAll('.opt').forEach(el=>{
      el.classList.toggle('picked', el.dataset.oid === id);
      const b = el.querySelector('.bullet');
      if(!b) return;
      if(el.dataset.oid === id){
        b.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="#0b1220" xmlns="http://www.w3.org/2000/svg"><path d="M20.285 6.709a1 1 0 0 1 0 1.414l-10.01 10.01a1 1 0 0 1-1.414 0L3.715 12.99a1 1 0 0 1 1.414-1.414l4.025 4.025 9.303-9.303a1 1 0 0 1 1.828.411z"/></svg>';
      } else {
        b.innerHTML = '';
      }
    });
  }

  async function join(){
    const body = {
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim()
    };
    if(!body.name){ toast('Please enter your name'); return; }

    // register via REST
    const res = await fetch('/api/room/'+code+'/register', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    if(!res.ok){ toast('Join failed'); return; }
    player = await res.json();

    // show game UI
    $reg.style.display='none';
    $game.style.display='block';
    $playerName.textContent = player.name || 'Player';
    $playerId.textContent = (player.id || '').slice(0,6);

    // connect / or if already connected, send identity
    ensureSocket(() => {
      ws.send(JSON.stringify({
        type:'register',
        playerId: player.id,
        player: { id: player.id, name: player.name, email: player.email }
      }));
    });
  }

  function ensureSocket(onOpen){
    if(ws && ws.readyState === WebSocket.OPEN){ onOpen && onOpen(); return; }
    const url = (location.protocol === 'https:' ? 'wss':'ws')+'://'+location.host+'/ws/'+code;
    ws = new WebSocket(url);
    ws.addEventListener('open', () => {
      // initial lightweight register (some gateways need a first frame)
      ws.send(JSON.stringify({type:'register'}));
      onOpen && onOpen();
    });
    ws.addEventListener('message', (ev) => {
      const msg = JSON.parse(ev.data);
      if(msg.type === 'question'){ renderQuestion(msg.question, msg.deadline); }
      if(msg.type === 'status'){ toast(msg.message || ''); }
      if(msg.type === 'result'){
        // optional feedback: show a subtle marker on your pick
        if(chosenId){
          // highlight my pick as correct/incorrect
          const mine = document.querySelector(`.opt[data-oid="${chosenId}"]`);
          if(mine){
            mine.classList.add(chosenId === msg.correct_option_id ? 'correct':'incorrect');
          }
        }
        $status.textContent = 'Time up';
        stopCountdown();
      }
    });
    ws.addEventListener('close', () => {
      // try to reconnect silently
      setTimeout(()=> ensureSocket(onOpen), 1000);
    });
  }

  function sendAnswer(optionId){
    if(!ws || ws.readyState !== WebSocket.OPEN){ toast('Connection lost'); return; }
    ws.send(JSON.stringify({ type:'answer', playerId: player.id, optionId }));
  }

  // wire up
  document.getElementById('join').addEventListener('click', join);

  // If the user loaded page already with room param, prep socket (identity comes after join)
  if(code){ ensureSocket(); }
})();
</script>
</body>
</html>
