<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Fullscreen Exit Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #000; color: #fff; text-align: center; }
        .big-btn { padding: 20px 40px; font-size: 20px; margin: 20px; border: none; border-radius: 10px; cursor: pointer; }
        .test-btn { background: #0d6efd; color: white; }
        .fullscreen-btn { background: #198754; color: white; }
        .exit-btn { background: #dc3545; color: white; }
        .status { padding: 15px; margin: 20px; border-radius: 10px; font-size: 18px; }
        .success { background: #0f5132; }
        .warning { background: #664d03; }
        .error { background: #58151c; }
    </style>
</head>
<body>
    <h1>üîí Fullscreen Exit Detection Test</h1>
    
    <div class="status" id="status">Ready to test fullscreen exit detection</div>
    
    <button class="big-btn test-btn" onclick="openQuizTest()">
        üöÄ Open Quiz Test (Room: 9V55D)
    </button>
    
    <button class="big-btn fullscreen-btn" onclick="enterFullscreen()">
        üì± Enter Fullscreen Mode
    </button>
    
    <button class="big-btn exit-btn" onclick="exitFullscreen()">
        üö™ Exit Fullscreen (Test Warning)
    </button>
    
    <div style="margin-top: 40px;">
        <h3>üìã Test Instructions:</h3>
        <ol style="text-align: left; max-width: 600px; margin: 0 auto;">
            <li><strong>Open Quiz:</strong> Click "Open Quiz Test" button</li>
            <li><strong>Join Game:</strong> Fill in your details and join</li>
            <li><strong>Enter Fullscreen:</strong> The quiz should auto-enter fullscreen</li>
            <li><strong>Test Exit:</strong> Press ESC key or use device back button to exit fullscreen</li>
            <li><strong>Expected Result:</strong>
                <ul>
                    <li>üî¥ Screen flashes red briefly</li>
                    <li>‚ö†Ô∏è Warning toast appears</li>
                    <li>üîí Automatically re-enters fullscreen</li>
                    <li>üíæ Warning saved to database</li>
                </ul>
            </li>
        </ol>
    </div>

    <div style="margin-top: 30px;">
        <h3>üîç Debug Info:</h3>
        <div id="debug" style="background: #222; padding: 15px; border-radius: 10px; font-family: monospace; text-align: left; max-width: 600px; margin: 0 auto;"></div>
    </div>

    <script>
        let debugEl = document.getElementById('debug');
        let statusEl = document.getElementById('status');
        
        function addDebug(msg) {
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML += `[${timestamp}] ${msg}<br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }
        
        function updateStatus(msg, type = 'warning') {
            statusEl.innerHTML = msg;
            statusEl.className = `status ${type}`;
        }
        
        function openQuizTest() {
            window.open('https://realtime-quiz-worker.shubhodippal01.workers.dev/play_sse.html?room=9V55D', '_blank');
            updateStatus('Quiz test opened in new tab - join and test fullscreen exit!', 'success');
            addDebug('Quiz test window opened');
        }
        
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen().then(() => {
                    updateStatus('Fullscreen entered - press ESC to test exit detection', 'success');
                    addDebug('Entered fullscreen mode');
                }).catch(err => {
                    updateStatus('Failed to enter fullscreen: ' + err.message, 'error');
                    addDebug('Fullscreen failed: ' + err.message);
                });
            } else {
                updateStatus('Fullscreen not supported on this browser', 'error');
                addDebug('Fullscreen not supported');
            }
        }
        
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen().then(() => {
                    updateStatus('Exited fullscreen manually', 'warning');
                    addDebug('Manually exited fullscreen');
                }).catch(err => {
                    addDebug('Exit fullscreen failed: ' + err.message);
                });
            } else {
                updateStatus('Not in fullscreen mode', 'warning');
                addDebug('Not currently in fullscreen');
            }
        }
        
        // Monitor fullscreen changes
        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                    document.mozFullScreenElement || document.msFullscreenElement);
            
            if (isFullscreen) {
                updateStatus('‚úÖ Fullscreen mode active', 'success');
                addDebug('Fullscreen change: ENTERED fullscreen');
            } else {
                updateStatus('‚ö†Ô∏è Fullscreen mode exited', 'warning');
                addDebug('Fullscreen change: EXITED fullscreen');
            }
        }
        
        // Add fullscreen listeners
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        // Initial debug
        addDebug('Fullscreen test page loaded');
        addDebug('Device: ' + navigator.userAgent.substring(0, 50) + '...');
        
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        addDebug('Mobile device: ' + (isMobile ? 'YES' : 'NO'));
    </script>
</body>
</html>
